{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro - Gestión de Proyectos</title>

  <link rel="stylesheet" href="{% static 'css/register.css' %}" />

</head>
<body>
  <div class="register-container">
    <div class="register-left">
      <h1>✨ Únete a Nosotros</h1>
      <p>
        Crea tu cuenta y forma parte de nuestra plataforma de gestión de proyectos.
        Conecta como cliente para publicar proyectos o como desarrollador para colaborar en proyectos increíbles.
      </p>
    </div>

    <div class="register-right">
      <!-- 1) novalidate desactiva la validación nativa del navegador -->
      <!-- 2) onsubmit llama a send_register(event) para bloquear el POST y validar custom -->
      <form method="post" class="register-form" id="registerForm" novalidate>
        <h2>Crear Cuenta</h2>

        {% csrf_token %}

        <div id="formMessages" class="messages" aria-live="polite"></div>

        <div class="form-row">
          <div class="form-group">
            <label for="first_name">Nombre <span class="required">*</span></label>
            <input type="text" id="first_name" name="first_name" placeholder="Tu nombre" autocomplete="given-name" />
            <div class="field-error" id="err_first_name"></div>
          </div>
          <div class="form-group">
            <label for="last_name">Apellidos <span class="required">*</span></label>
            <input type="text" id="last_name" name="last_name" placeholder="Apellidos" autocomplete="family-name" />
            <div class="field-error" id="err_last_name"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="username">Nombre de Usuario <span class="required">*</span></label>
            <input type="text" id="username" name="username" autocomplete="username" placeholder="Elige un nombre de usuario" />
            <div class="field-error" id="err_username"></div>
          </div>
          <div class="form-group">
            <label for="email">Email <span class="required">*</span></label>
            <input type="email" id="email" name="email" autocomplete="email" placeholder="tu@email.com" />
            <div class="field-error" id="err_email"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="password1">Contraseña <span class="required">*</span></label>
            <input type="password" id="password1" name="password1" autocomplete="new-password" placeholder="Mínimo 8 caracteres" />
            <div class="field-error" id="err_password1"></div>
          </div>
          <div class="form-group">
            <label for="password2">Repetir Contraseña <span class="required">*</span></label>
            <input type="password" id="password2" name="password2" autocomplete="new-password" placeholder="Confirma tu contraseña" />
            <div class="field-error" id="err_password2"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="tipo_usuario">Tipo de Usuario <span class="required">*</span></label>
            <select id="tipo_usuario" name="tipo_usuario">
              <option value="">Selecciona tu rol</option>
              <option value="cliente">Cliente - Tengo proyectos para desarrollar</option>
              <option value="desarrollador">Desarrollador - Quiero trabajar en proyectos</option>
            </select>
            <div class="field-error" id="err_tipo_usuario"></div>
          </div>
          <div class="form-group">
            <label for="telefono">Teléfono (Opcional)</label>
            <input type="tel" id="telefono" name="telefono" placeholder="+34 612 345 678" />
            <div class="field-error" id="err_telefono"></div>
          </div>
        </div>

        <button type="submit" class="btn-register">Crear Cuenta</button>
      </form>

      <div class="auth-links">
        <!-- <a href="{% url 'auth:login' %}">¿Ya tienes cuenta? Iniciar sesión</a> -->
        <!-- <a href="{% url 'index' %}">← Volver a la página principal</a> -->
        <a href="#" id="fakeLogin">¿Ya tienes cuenta? Iniciar sesión</a>
        <a href="#" id="fakeHome">← Volver a la página principal</a>
      </div>
    </div>
  </div>

  <script>
    // ===== Helpers de UI =====
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);

    function setError(input, msg){
      input.classList.add('is-invalid');
      input.classList.remove('is-valid');
      const err = document.getElementById('err_'+input.id);
      if(err) err.textContent = msg || '';
    }
    
    function clearError(input){
      input.classList.remove('is-invalid');
      input.classList.remove('is-valid');
      const err = document.getElementById('err_'+input.id);
      if(err) err.textContent = '';
    }
    
    function setValid(input){
      input.classList.remove('is-invalid');
      input.classList.add('is-valid');
      const err = document.getElementById('err_'+input.id);
      if(err) err.textContent = '';
    }

    function showFormMessage(type, text){
      const box = document.getElementById('formMessages');
      box.innerHTML = `<div class="alert ${type==='error'?'alert-error':'alert-success'}">${text}</div>`;
    }

    // ===== Normalizadores =====
    function normalizeLowercase(input){ input.value = input.value.toLowerCase().trim(); }
    function normalizeName(input){ input.value = input.value.replace(/\s+/g,' ').trim(); }

    // ===== Reglas de validación =====
    const patterns = {
      name: /^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ][A-Za-zÁÉÍÓÚÜÑáéíóúüñ\s'-]{1,48}$/,
      username: /^[a-z][a-z0-9_]{2,19}$/,
      email: /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/,
      phoneIntl: /^\+?[0-9\s-]{7,18}$/,
      strongPass: /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d!@#$%^&*()_+=\-{}\[\]:;"'`,.<>/?~]{8,}$/
    };

    function validateFirstName(){
      const el = document.getElementById('first_name');
      normalizeName(el);
      if(!el.value){ setError(el,'El nombre es obligatorio'); return false; }
      if(!patterns.name.test(el.value)){ setError(el,'Usa solo letras y mínimo 2 caracteres'); return false; }
      setValid(el); return true;
    }
    
    function validateLastName(){
      const el = document.getElementById('last_name');
      normalizeName(el);
      if(!el.value){ setError(el,'Los apellidos son obligatorios'); return false; }
      if(el.value.length < 2){ setError(el,'Mínimo 2 caracteres'); return false; }
      setValid(el); return true;
    }
    
    function validateUsername(){
      const el = document.getElementById('username');
      normalizeLowercase(el);
      if(!el.value){ setError(el,'El usuario es obligatorio'); return false; }
      if(!patterns.username.test(el.value)){ setError(el,'3-20 chars, empieza por letra. Solo minúsculas, números y _'); return false; }
      setValid(el); return true;
    }
    
    function validateEmail(){
      const el = document.getElementById('email');
      normalizeLowercase(el);
      if(!el.value){ setError(el,'El email es obligatorio'); return false; }
      if(!patterns.email.test(el.value)){ setError(el,'Formato de email no válido'); return false; }
      setValid(el); return true;
    }
    
    function validatePassword1(){
      const el = document.getElementById('password1');
      if(!el.value){ setError(el,'La contraseña es obligatoria'); return false; }
      if(!patterns.strongPass.test(el.value)){ setError(el,'Mín 8, al menos una letra y un número'); return false; }
      setValid(el); return true;
    }

    function validatePassword2(){
      const el1 = document.getElementById('password1');
      const el2 = document.getElementById('password2');
      if(!el2.value){ setError(el2,'Repite la contraseña'); return false; }
      if(el1.value !== el2.value){ setError(el2,'Las contraseñas no coinciden'); return false; }
      setValid(el2); return true;
    }

    function validateRole(){
      const el = document.getElementById('tipo_usuario');
      if(!el.value){ setError(el,'Selecciona un rol'); return false; }
      setValid(el); return true;
    }

    function validatePhone(){
      const el = document.getElementById('telefono');
      const v = el.value.trim();
      if(!v){ clearError(el); return true; }
      if(!patterns.phoneIntl.test(v)){ setError(el,'Teléfono no válido'); return false; }
      setValid(el); return true;
    }

    function validateAll(){
      const results = [
        validateFirstName(),
        validateLastName(),
        validateUsername(),
        validateEmail(),
        validatePassword1(),
        validatePassword2(),
        validateRole(),
        validatePhone()
      ];
      return results.every(Boolean);
    }

    // --- Helpers nuevos ---
    function getCSRF() {
    const el = document.querySelector('[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
    }

    function applyServerErrors(errors) {
    // Espera un dict tipo: { field: ["msg1","msg2"], "__all__": ["msg global"] }
    let globalMsgs = [];
    Object.entries(errors || {}).forEach(([field, msgs]) => {
        const id = field === "__all__" ? null : field;
        const input = id ? document.getElementById(id) : null;
        const text = Array.isArray(msgs) ? msgs.join(' ') : String(msgs);

        if (input) setError(input, text);
        else globalMsgs.push(text);
    });
    if (globalMsgs.length) showFormMessage('error', globalMsgs.join(' '));
    }

    // Envía el formulario de registro
    async function send_register(e){

        e.preventDefault();
        document.getElementById('formMessages').innerHTML = '';

        const ok = validateAll();
        if (!ok) {
            showFormMessage('error','Revisa los campos marcados en rojo.');
            return false;
        }

        const form = document.getElementById('registerForm');
        const btn = form.querySelector('.btn-register');
        const data = new FormData(form);

        // Estado cargando
        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = 'Enviando...';

        try {
            const resp = await fetch(form.action, {
            method: 'POST',
            body: data,
            headers: {
                'X-CSRFToken': getCSRF(),
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json' // ayuda a que devuelvas JSON desde Django
            },
            redirect: 'follow'
            });

            // Si Django responde con redirect (típico al crear usuario)
            if (resp.redirected) {
            window.location.href = resp.url;
            return false;
            }

            // Intenta leer JSON; si no es JSON, asume HTML y navega
            let payload = null;
            const ct = resp.headers.get('Content-Type') || '';
            if (ct.includes('application/json')) {
            payload = await resp.json();
            } else {
            // Si no devuelves JSON, puedes redirigir manualmente a una ruta de éxito:
            // window.location.href = '/';
            // o mostrar éxito genérico:
            showFormMessage('success','✅ Registro completado.');
            return false;
            }

            if (resp.ok) {
            // Espera algo como {success: true, redirect_url: "..."} opcional
            showFormMessage('success', (payload && payload.message) || '✅ Registro completado.');
            if (payload && payload.redirect_url) {
                window.location.href = payload.redirect_url;
            }
            // Si no hay redirect, te quedas en la página con el mensaje
            return false;
            } else if (resp.status === 400) {
            // Errores de validación desde Django
            if (payload && payload.errors) {
                applyServerErrors(payload.errors);
            } else {
                showFormMessage('error','❌ Datos no válidos.');
            }
            return false;
            } else {
            showFormMessage('error','❌ Error en el servidor. Inténtalo de nuevo.');
            return false;
            }
        } catch (err) {
            console.error(err);
            showFormMessage('error','❌ No se pudo contactar con el servidor.');
            return false;
        } finally {
            btn.disabled = false;
            btn.textContent = oldText;
        }
        }

    // ===== Wiring =====
    document.addEventListener('DOMContentLoaded', ()=>{
      const form = document.getElementById('registerForm');
      form.addEventListener('submit', send_register);

      // Validación en blur/input
      $('#first_name').addEventListener('blur', validateFirstName);
      $('#last_name').addEventListener('blur', validateLastName);
      $('#username').addEventListener('input', (e)=>{ e.target.value = e.target.value.toLowerCase(); });
      $('#username').addEventListener('blur', validateUsername);
      $('#email').addEventListener('input', (e)=>{ e.target.value = e.target.value.toLowerCase(); });
      $('#email').addEventListener('blur', validateEmail);
      $('#password1').addEventListener('blur', validatePassword1);
      $('#password2').addEventListener('input', validatePassword2);
      $('#tipo_usuario').addEventListener('change', validateRole);
      $('#telefono').addEventListener('blur', validatePhone);

      // Validación en tiempo real de contraseñas (estilo visual mínimo)
      const p1 = document.getElementById('password1');
      const p2 = document.getElementById('password2');
      function livePwd(){
        if(!p1.value || !p2.value) return;
        if(p1.value !== p2.value){ setError(p2,'Las contraseñas no coinciden'); }
        else { setValid(p2); }
      }
      p1.addEventListener('input', livePwd);
      p2.addEventListener('input', livePwd);

      
    });
    
  </script>
</body>
</html>
